
{%- assign has_glb = false -%}
{%- assign glb_url = '' -%}
{%- assign has_ar_tag = false -%}
{%- for tag in product.tags -%}
  {%- if tag == 'AR-Ring-Try-On' -%}
    {%- assign has_ar_tag = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}
{%- if has_ar_tag -%}
  {%- for media in product.media -%}
    {%- if media.media_type == 'model' -%}
      {%- for source in media.sources -%}
        {%- if source.format == 'glb' -%}
          {%- assign has_glb = true -%}
          {%- assign glb_url = source.url -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if has_glb %}{% break %}{% endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- if has_glb and glb_url != blank -%}
<style>
  .ar-tryon-wrapper {
    margin: 24px 0;
    text-align: center;
  }
  .ar-tryon-btn {
    width: 100%;
    max-width: 420px;
    min-height: 56px;
    padding: 0 36px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    color: {{ block.settings.text_color }};
    background: linear-gradient(135deg, {{ block.settings.button_color }}, #111);
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    transition: transform 0.25s ease, box-shadow 0.25s ease, opacity 0.25s ease;
  }
  .ar-tryon-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 14px 40px rgba(0,0,0,0.35);
    opacity: 0.95;
  }
  #ar-fullscreen-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 2147483647;
    {% comment %} background: rgba(0,0,0,0.95); {% endcomment %}
    backdrop-filter: blur(15px);
    animation: arFadeIn 0.3s ease forwards;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
  }
  @keyframes arFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  #ar-viewer-container {

    {% comment %} position: relative;
    width: 100%;
    max-width: 900px;
    height: 80vh;
    max-height: 700px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    margin-top:6rem;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
 {% endcomment %}

    position: relative;
    width: 36rem;
    max-width: 1020px;
    height: 36.5rem;
    max-height: 1039px;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 4rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }
  #ar-viewer-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  .ar-modal-header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  .ar-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: rgba(0, 0, 0, 0.62);
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    z-index: 20;
    backdrop-filter: blur(6px);
    transition: background 0.5s;
  }
  .ar-close-btn:hover {
    background: rgba(255,255,255,0.4);
  }
  @media (max-width: 768px) {
    /* On mobile, keep original fullscreen experience */
    #ar-fullscreen-overlay {
      padding: 0;
    }
    #ar-viewer-container {
      width: 100%;
      height: 100vh;
      max-width: none;
      max-height: none;
      border-radius: 0;
     margin-top: 0rem;


    }
    .ar-modal-header {
      display: none;
    }
  }
 @media (max-width: 926px) {
    /* On mobile, keep original fullscreen experience */
    #ar-fullscreen-overlay {
      padding: 0;
    }
    #ar-viewer-container {
      width: 100%;
      height: 100vh;
      max-width: none;
      max-height: none;
      border-radius: 0;
     margin-top: 0rem;


    }
    .ar-modal-header {
      display: none;
    }
  }

  /* Naya rule: Jab AR modal open ho to product recommendations hide kar do */
  body.ar-modal-open .product-recommendations {
    display: none !important;
  }

  /* ðŸ”¥ NEW: Remove scrollbar gap (prevent page shift when overlay opens) */

  body.ar-modal-open {
    overflow: hidden;
    padding-right: 0 !important; /* Prevents default browser scrollbar compensation */
    margin-right: 0 !important;
  }
  /* Optional: Hide scrollbar but keep functionality (smooth feel) */
  {% comment %} body.ar-modal-open::-webkit-scrollbar {
    display: none; {% endcomment %}
  }
  body.ar-modal-open {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
<div class="ar-tryon-wrapper">
  <button
    type="button"
    id="ar-try-on-trigger-btn"
    class="ar-tryon-btn"
  >
    {{ block.settings.button_text | default: 'Try On in AR' }}
  </button>
</div>
<div id="ar-fullscreen-overlay">
  <div id="ar-viewer-container">
    <div class="ar-modal-header">Try On Ring in AR</div>
    <button class="ar-close-btn" id="ar-close-btn">Ã—</button>
    <iframe
      id="ar-viewer-iframe"
      allow="camera; microphone; gyroscope; accelerometer; fullscreen; autoplay"
      sandbox="allow-scripts allow-same-origin allow-popups allow-modals allow-top-navigation-by-user-activation"
      loading="lazy"
    ></iframe>
  </div>
</div>
<script>
  const viewerBaseUrl = 'https://ar-viewer.ar-jewelry.com/';
  const directGlbUrl = '{{ glb_url }}';
  document.getElementById('ar-try-on-trigger-btn').addEventListener('click', function () {
    const overlay = document.getElementById('ar-fullscreen-overlay');
    const iframe = document.getElementById('ar-viewer-iframe');
    const productId = '{{ product.id | split: '/' | last }}';
    iframe.src = `${viewerBaseUrl}?glb=${encodeURIComponent(directGlbUrl)}&product_id=${productId}&embedded=true`;
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.body.classList.add('ar-modal-open');
  });
  document.getElementById('ar-close-btn').addEventListener('click', function () {
    const overlay = document.getElementById('ar-fullscreen-overlay');
    const iframe = document.getElementById('ar-viewer-iframe');
    overlay.style.display = 'none';
    iframe.src = '';
    document.body.style.overflow = '';
    document.body.classList.remove('ar-modal-open');
  });
</script>

{%- endif -%}
{% schema %}

{
  "name": "AR Try-On Button",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Try On in AR"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Background Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}